name: Build Android APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Auto-Fix Files
      run: |
        echo "ğŸ” æ­£åœ¨å¯»æ‰¾ä»£ç æ–‡ä»¶..."
        # è‡ªåŠ¨æŸ¥æ‰¾ main.py çš„ä½ç½®
        MAIN_PATH=$(find . -name main.py | head -n 1)
        
        if [ -z "$MAIN_PATH" ]; then
          echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ° main.pyï¼è¯·ç¡®ä¿æ‚¨å·²ä¸Šä¼ ä»£ç ã€‚"
          exit 1
        fi
        
        DIR_NAME=$(dirname "$MAIN_PATH")
        echo "âœ… åœ¨ [$DIR_NAME] å‘ç°äº†ä»£ç "
        
        # å¦‚æœä»£ç ä¸åœ¨æ ¹ç›®å½•ï¼Œè¿™å°±æŠŠå®ƒä»¬æ¬è¿‡æ¥
        if [ "$DIR_NAME" != "." ]; then
          echo "ğŸ“¦ æ­£åœ¨ç§»åŠ¨æ–‡ä»¶åˆ°æ ¹ç›®å½•..."
          cp -r "$DIR_NAME"/* .
        fi
        
        # å¦‚æœç¼ºå°‘ä¾èµ–æ–‡ä»¶ï¼Œè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª
        if [ ! -f "requirements.txt" ]; then
          echo "âš ï¸ æœªæ‰¾åˆ° requirements.txtï¼Œæ­£åœ¨è‡ªåŠ¨ç”Ÿæˆ..."
          echo "flet" > requirements.txt
          echo "requests" >> requirements.txt
          echo "beautifulsoup4" >> requirements.txt
          echo "pytz" >> requirements.txt
        fi
        
        echo "ğŸ“‚ æ–‡ä»¶å‡†å¤‡å°±ç»ªï¼"
        ls -l

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.19.0'

    - name: Flet Build APK
      run: |
        flet build apk --verbose

    - name: Upload APK
      uses: actions/upload-artifact@v3
      with:
        name: football-fixtures-apk
        path: build/apk/app-release.apk
